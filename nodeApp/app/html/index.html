
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
<script src="FileSaver.js" ></script>
<!-- <script src="pathBuilder.js" ></script> -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/jstree/3.3.5/themes/default/style.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/jstree/3.3.5/jstree.min.js"></script>

<div class="container-fluid">
  <div class="row bg-dark text-light">
    <div class="form-group m-2">
      <div class="dropdown">
        <div class="form-group">
          <button class="btn btn-primary dropdown-toggle" type="button" id="dropdownProjects" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Select a project !
          </button>
          <div class="dropdown-menu" aria-labelledby="dropdownProjects" id="listProjects">
          </div>
        </div>
      </div>
    </div>
    <div class="form-group ml-2">
      <label for="projectLabel">Project</label>
      <input class="form-control" id="projectLabel" readonly>
    </div>
    <div class="form-group ml-2">
      <label for="projectVersion">Version</label>
      <input class="form-control" id="projectVersion" readonly>
    </div>
    <div class="form-group ml-2">
      <button type="button" class="btn btn-primary mt-2" id="previous">Previous</button>
      <button type="button" class="btn btn-primary mt-2" id="next">Next</button>
      <div id = "studyId">
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col bg-dark text-light">
      <div class="col">
        <div class="form-group">
          <label for="exploredClass">Class to explore</label>
          <input class="form-control" id="exploredClass">
        </div>
        <div class="form-group">
          <label for="autoNumber">Auto Number</label>
          <input class="form-control" id="autoNumber">
        </div>
        <div class="form-group">
          <label for="fatherLab">Class to create</label>
          <input class="form-control" id="fatherLab">
        </div>
        <div class="form-group">
          <label for="listeVar">List of variables</label>
          <textarea class="form-control" id="listeVar" rows="3"></textarea>
          <button type="button" class="btn btn-success mt-2" id="addFils">Add to class</button>
        </div>
      </div>
      <div class="col">
        <div class="form-group">
          <button type="button" class="btn btn-primary mt-2 invisible" id="save">Save</button>
          <button type="button" class="btn btn-danger mt-2 invisible" id="build">build mappings</button>
        </div>
      </div>
    </div>
    <div class="col-5 pl-5">
      <div class="row ">
        <div class="form-group">
          <label for="search">Search</label>
          <input class="form-control" type="text" id="search" value="">
        </div>
      </div>
      <div class="row">
        <div id="tree"></div>
      </div>
    </div>
    <div class="col-5 mt-4 pl-5" >
          <div class="border" id = "dbgap"></div>
    </div>
  </div>
</div>
<script>
  $(function(){
    $('#tree').jstree({
      'core' : {
        "check_callback" : true,
        'data' : [{"text" : "Select a file"
        }],
      },
      "plugins" : ["contextmenu","dnd","sort","search"],
    });
  })
  $('#readFiles').click(function() {
    var mappingFile = $('#mappingFile').val();
    console.log(mappingFile);
    if (mappingFile!=""){
      var modifFile = $('#modifFile').val();
      var url = "http://localhost:3000/tree?mapping="+mappingFile+"&modif="+modifFile;
      var uri = encodeURI(url);
      $('#tree').jstree('destroy');
      $('#tree').jstree({
    		'core' : {
          "check_callback" : true,
    			'data' : {
            'url' : uri,
             "dataType" : "json"
          },
        },
        "plugins" : ["contextmenu","dnd","sort","search"],
      });
    }else{
      console.log("Pas de fichier")
    }
  });

  $('#save').click(function(){
    var json = $('#tree').jstree(true).get_json();
    // var modifFile = $('#SaveModifFile').val();
    var project = $('#projectLabel').val();
    // var version = $('#projectVersion').val();
    var data = {};
    data.json = json;
    data.project = project;
    // data.version = version;
    // data.modifFile = modifFile;
    $.ajax({
      url: "http://localhost:3000/save",
      type: 'PUT',
      contentType: 'application/json',
      data: JSON.stringify(data)
    }).done(function(){
      readProject(project);
    });

    // var modif = buildPathFromJsTree(json);
    // var blob = new Blob([JSON.stringify(modif)], {type: "text/plain;charset=utf-8"});

    // saveAs(blob, "modif.json");
  })

  $('#build').click(function(){
    var json = $('#tree').jstree(true).get_json();
    // var modif = buildPathFromJsTree(json);
    // var blob = new Blob([JSON.stringify(modif)], {type: "text/plain;charset=utf-8"});
    var project =  $('#projectLabel').val();
    var version = $('#projectVersion').val();

    var url = "http://localhost:3000/build?project="+project+"&version="+version;
    var uri = encodeURI(url);
    $.ajax({
      url: uri,
      type: 'GET',
    }).done(function(data){
      var blob = new Blob([data], {type: "text/plain;charset=utf-8"});
      saveAs(blob, "built-mapping.csv");
    });
      // saveAs(blob, "modif.json");
  })

  var to = false;
  $('#search').keydown(function (e) {
    if (e.keyCode == 13){
      if ($('#search').val().length > 2){
        var v = $('#search').val();
        $('#tree').jstree(true).search(v);
      }
    }
 });

 $('#addFils').click(function () {
  console.log($('#tree').jstree("get_selected",true)[0].text);
  var instance = $('#tree').jstree(true);
  var selected = instance.get_selected()[0];
  var childs = instance.get_node(selected).children;
  var strSearch = $('#listeVar').val().split('\n')
  var nodeName = $('#fatherLab').val()

  console.log(strSearch);
  var newNode = instance.create_node(selected,nodeName);
  for( j in strSearch){
    for (i in childs){
      // console.log(instance.get_node(childs[i]).text);
      if (instance.get_node(childs[i]).text.endsWith('('+strSearch[j].trim()+')')){
          console.log(instance.get_node(childs[i]));
          console.log(instance.get_node('j1_1'));

          instance.move_node(instance.get_node(childs[i]),newNode)
      }
    }
  }


 });

 $(document).ready(function(){
   $('#projectLabel').val("");
   $('#projectVersion').val("");
   $('#exploredClass').val("");
   $('#fatherLab').val("");
   $('#listeVar').val("");
   $('#autoNumber').val("01");
   var uri = "http://localhost:3000/projects"
   $.ajax({
     url: uri,
     type: 'GET',
   }).done(function(data){
     for(i in data){
       console.log(data[i]);
       $('#listProjects').append('<a class="dropdown-item project-item" id="'+data[i]+'"href="#">'+data[i]+'</a>');
     }
   })

  //  var uriDgbap = "https://www.ncbi.nlm.nih.gov/projects/gap/cgi-bin/GetFolderView.cgi?current_study_id=phs000209.v13.p3&current_type=102&current_object_id=236&current_folder_type=102;"
  //  $.ajax({
  //    url: uriDgbap,
  //    type: 'GET',
  //  }).done(function(data){
  //    // console.log(data);
  //    $('#dbgap').append(data);
  //    $('.studyNode').append("<button>");
  //
  // })


// updateDbGap("phs000209.v13.p3","0","209","102");

 })

 function updateDbGap(studyId,type,objectId,typeFolder){
   console.log(studyId,type,objectId,typeFolder);
   var uriDgbap = "https://www.ncbi.nlm.nih.gov/projects/gap/cgi-bin/GetFolderView.cgi?current_study_id="+studyId+"&current_type="+type+"&current_object_id="+objectId+"&current_folder_type="+typeFolder+";"
   console.log(uriDgbap);
   $.ajax({
     url: uriDgbap,
     type: 'GET',
   }).done(function(data){
     // console.log(data);
     $('#dbgap').empty();
     $('#dbgap').append(data);
     $('#dbgap').find("div > ul ").each(function (index){
       console.log(index);
       if (index == 0) {
         $(this).attr("id","hierarchie")
       }else{
         $(this).attr("id","details")
       }
     })
     $('.studyNode').each(function(index){
      $(this).attr("onClick",$(this).attr("onClick").replace("updateAssociatedBox","updateDbGap"));
      $(this).append('\t\t<a href=# onClick = \'createFolder(event,"'+$(this).text()+'")\'" title ="Add vars to class"><img src="https://img.icons8.com/metro/15/000000/add-folder.png"></a> \t \t');
     });

     var groupNodes = $('.groupNode');
     groupNodes.each(function (index) {
       $(this).attr("onClick",$(this).attr("onClick").replace("updateAssociatedBox","updateDbGap").replace(/setState\([^\)]*\)\;/,""));
       $(this).append('\t\t<a href=# onClick = \'createFolder(event,"'+$(this).text()+'")\'" title ="Add vars to class"><img src="https://img.icons8.com/metro/15/000000/add-folder.png"></a> \t \t');
       if ($(this)[0] == groupNodes.last()[0]){
         if ($('#details').children().first().children().first()[0].tagName == "A"){
           console.log($(this).text());
           $(this).append('\t\t<a href=# onClick = \'feedVars(event,"'+$(this).text()+'")\'" title ="Add vars to class"><img src="https://img.icons8.com/metro/10/000000/nui2.png"></a> \t \t');
         }
       }
     });
  })
 }
 $("#listProjects").on('click',"a",function(event){
   event.preventDefault();
   var project = event.currentTarget.id;
   console.log(project);
   readProject(project,-1);
 });

 function readProject(project,version){
   console.log("read");
   var url = "http://localhost:3000/project?project="+project+"&version="+version;
   var uri = encodeURI(url);
   $('#tree').jstree('destroy');
   $.ajax({
     url: uri,
     type: 'GET',
   }).done(function(data){
     $('#projectLabel').val(data.project);
     $('#projectVersion').val(data.version);
     console.log(data.tree);
     $('#tree').jstree({
         'core' : {
           "check_callback" : true,
           'data' : data.tree
          },
         "plugins" : ["contextmenu","dnd","sort","search"],
    });
    if(data.version==-1){
      $("#build").addClass('invisible');
      $("#save").addClass('invisible');
    }else{
      $("#build").removeClass('invisible');
      $("#save").removeClass('invisible');
      $('#studyId').text(data.studyId + " - " + data.studyId.split(".")[0].replace(/phs[^1-9]*/,""));
      updateDbGap(data.studyId,"0",data.studyId.split(".")[0].replace(/phs[^1-9]*/,""),"102");
    }
   })
 }

 $('#previous').click(function(){
   var project =  $('#projectLabel').val();
   var version = $('#projectVersion').val();
   if (version>0){
     version = version -1;
   }
   readProject(project,version);
 })

 $('#next').click(function(){
   var project =  $('#projectLabel').val();
   var version = parseInt($('#projectVersion').val());
   version = version + 1;
   readProject(project,version);
 })

 function feedVars(event,label){
   event.preventDefault();
   var text="";
   $('#details').children().each(function(index){
     text+=$(this).text()+"\n";
     console.log($(this).text());
   })
   var value = $('#autoNumber').val();
   if(value){
     var index = parseInt(value);
     var indexAfter = index + 1;
     console.log("Hey " + value + index);
     if (index < 10){
       value = "0"+index;
     }else{
       value = index;
     }
   }
   label = value + " - " + label;
   $("#fatherLab").val(label);
   $("#listeVar").val(text);
   $("#autoNumber").val(indexAfter);
 }

 function createFolder(event, label){
   event.preventDefault();
   var value = $('#autoNumber').val();
   if(value){
     var index = parseInt(value);
     var indexAfter = index + 1;
     console.log("Hey " + value + index);
     if (index < 10){
       value = "0"+index;
     }else{
       value = index;
     }
   }
   label = value + " - " + label;
   $("#fatherLab").val(label);
   $("#listeVar").val();
   $("#autoNumber").val(indexAfter);
 }
</script>
